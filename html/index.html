<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>ChemnitzGeek</title>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>

    <link rel="stylesheet" href="noUiSlider.9.2.0/nouislider.min.css">

    <link rel="stylesheet" href="style.css"/>

    <script>
      class gameCollection {
        constructor(name, camelName, url) {
          this.name = name;
          this.camelName = camelName;
          this.url = url;
          this.games = null;
        }
      }

      var collections = [
        new gameCollection("Spielenacht 2016", "Spielenacht2016", "gameData.spielenacht2016.json"),
        new gameCollection("Spielenacht 2017", "Spielenacht2017", "gameData.json"),
        new gameCollection("Stadtbibliothek", "Stadtbibliothek", "gameData.json"),
        new gameCollection("Studentenwerk", "Studentenwerk", "gameData.json"),
      ];

      function matchesQuery(game) {
        var numPlayers = parseInt(document.forms["searchForm"]["inputNumPlayers"].value);

        var ratingMin = parseFloat(document.forms["searchForm"]["inputRatingMin"].value);
        var ratingMax = parseFloat(document.forms["searchForm"]["inputRatingMax"].value);
        var weightMin = parseFloat(document.forms["searchForm"]["inputWeightMin"].value);
        var weightMax = parseFloat(document.forms["searchForm"]["inputWeightMax"].value);
        if (numPlayers > 0 && (numPlayers < parseInt(game.minPlayers) || numPlayers > parseInt(game.maxPlayers)))  return false;
        if (parseFloat(game.rating) < ratingMin || parseFloat(game.rating) > ratingMax)  return false;
        if (parseFloat(game.weight) < weightMin || parseFloat(game.weight) > weightMax)  return false;
        return true;
      }

      function reloadGames() {
        for (i = 0; i < collections.length; i++) {
          if (! document.getElementById("check"+collections[i].camelName).checked) {
            continue;
          }

          console.log(collections[i].name);
          if (collections[i].games == null) {
            $.getJSON(collections[i].url, function(json) {
              collections[i].games = "asdf";//jQuery.extend(true, {}, json);
              console.log(collections[i].games);
            });
          }
          console.log(collections[i].games);
          //TODO: games is not defined in this scope! wtf
          document.getElementById("gameTableBody").innerHTML = "";
          games = collections[i].games;
          for (var j = 0; j < games.length; j++) {
            var game = games[j];
            if (!matchesQuery(game))  continue;

            var rowHTML = "";
            rowHTML += "<tr>";
            rowHTML += "<td>" + game.name + "</td>";
            rowHTML += "<td>" + game.rating + "</td>";
            rowHTML += "<td>" + game.minPlayers + " - " + game.maxPlayers + "</td>";
            rowHTML += "<td>" + game.minAge + "+</td>";
            rowHTML += "<td>" + game.weight + "</td>";
            rowHTML += "<td>" + game.yearPublished + "</td>";
            rowHTML += "</tr>";
            document.getElementById("gameTableBody").innerHTML += rowHTML;
          }
        }
      }
    </script>
  </head>
  <body>
    <!--<h1>ChemnitzGeek</h1>-->
    <div id="side">
      <form id="searchForm" class="sideForm">
        # Players:
        <input type="number" id="inputNumPlayers" name="numPlayers" value="0" min="0" max="99"/>
        <br/>
        Rating:
        <input type="text" id="inputRatingMin" name="inputRatingMin" value="0"/>
        <input type="text" id="inputRatingMax" name="inputRatingMax" value="10"/>
        <br/>
        Weight:
        <input type="hidden" id="inputWeightMin" name="inputWeightMin" value="1"/>
        <input type="hidden" id="inputWeightMax" name="inputWeightMax" value="5"/>
        <div id="soft"></div>
        <br/>
        Age:
        <input type="text" id="inputAgeMin" name="inputAgeMin" value="0"/>
        <input type="text" id="inputAgeMax" name="inputAgeMax" value="99"/>
        <br/>
        Year::
        <input type="text" id="inputYearMin" name="inputYearMin" value="0"/>
        <input type="text" id="inputYearMax" name="inputYearMax" value="3000"/>
        <br/>
        <input type="button" id="inputSubmit" value="Refresh" onclick="reloadGames();"/>
      </form>
      <form id="collectionsForm" class="sideForm">
        <script>
          collectionBoxes = "";
          for (i = 0; i < collections.length; i++) {
            collectionBoxes += "<input type=\"checkbox\" id=\"check" + collections[i].camelName + "\" name=\"" + collections[i].camelName + "\" value=\"" + collections[i].camelName + "\"" + (i==0 ? " checked" : "") + "/> " + collections[i].name + "<br/>";
          }
          document.getElementById("collectionsForm").innerHTML = collectionBoxes;
        </script>
      </form>
    </div>
    <div id="searchResults">
      <table id="gameTable">
        <thead id="gameTableHead">
          <tr>
            <th>Name</th>
            <th>Rating</th>
            <th>Players</th>
            <th>Age</th>
            <th>Weight</th>
            <th>Year</th>
          </tr>
        </thead>
        <tbody id="gameTableBody"/>
      </table>
    </div>

    <script src="noUiSlider.9.2.0/nouislider.min.js"></script>
    <script>
      var softSlider = document.getElementById('soft');
      noUiSlider.create(softSlider, {
        start: [1, 3],
        connect: [false, true, false],
        margin: 1,
        step: 0.5,
        range: {
          min: 1,
          max: 5
        }
      });
      softSlider.noUiSlider.on('update', function(values, handle) {
        var inputWeightHidden = [document.getElementById("inputWeightMin"), document.getElementById("inputWeightMax")];
        inputWeightHidden[handle].value = values[handle];
      });
    </script>
  </body>
</html>
